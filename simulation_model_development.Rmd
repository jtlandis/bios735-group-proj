---
title: "Vector PAR Model Summary - Simulation"
author: 'Group 3: Abby Foes, Zheng Lan, Justin Landis, Yu Liu, Alec Reinhardt'
date: "`r Sys.Date()`"
output: html_document
---
```{r}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(dplyr)
library(tibble)
library(ggplot2)
```

$$
y_{it} \sim \text{Poisson}(m_{it})
$$
$$
m_{it} = \sum_{l=1}^{q} \beta_{i,l} y_{i,t-l} +
\left(1 - \sum_{l=1}^{q} \beta_{i,l} \right) \cdot
\exp\left( \mu + \mu_{g_i} + \eta_i + f_t + \mathbf{x}_{it}^\top \gamma_i \right)
$$
Where:

* $\beta_{i,l}$: item-specific AR coefficients (constrained so sum $\leq$ 1)
* $\mu$: global intercept
* $\mu_{g_i}$: brand-specific intercept for item i
* $\eta_i$: item-specific intercept
* $f_t$: shared time effect across all items
* $\gamma_i$: item-specific covariate effects
	
Model Hierarchy

Brand-Level

* $\mu_{g} \sim N(0, 1)$ — brand intercepts
* $\mu_g$: brand-specific prior means for covariate effects
* $\gamma_i \sim N(\mu_{g_i}, \sigma_g^2 \mathbf{I})$

Item-Level

* $\eta_i \sim N(0, \sigma_\eta^2)$ — item intercept
* $\beta_{i,\cdot} \sim \text{Dirichlet}(\cdot)$, scaled by $\tau_i \sim \text{Beta}(a, b)$

Time-Level

* $f_t \sim \mathcal{N}(0, 1)$ — shared time effect


# Simulation Parameters
```{r}
devtools::load_all()
set.seed(2025)
sim_data <- simulate_vector_par(n_items = 12, n_brands = 3, T = 100, q = 1)
true_mu_brand <- attr(sim_data, "true_params")$mu_brand
true_eta <- attr(sim_data, "true_params")$eta
true_f <- attr(sim_data, "true_params")$f
```

# Prepare Stan Data and Fit
```{r}
stan_input <- prepare_data_stan_vectorpar(sim_data, q = 1)
fit <- fit_vector_par_stan(stan_input)
```

# Posterior Summaries
```{r}
summary_eta <- fit$summary(variables = paste0("eta[", 1:12, "]"))
summary_mu <- fit$summary(variables = paste0("mu_brand[", 1:3, "]"))
summary_f <- fit$summary(variables = paste0("f[", 1:length(true_f), "]"))
```

# True vs Estimated: Combined Plot
```{r}
df_mu <- tibble(
  type = "Brand Intercept",
  index = seq_along(true_mu_brand),
  true = true_mu_brand,
  estimate = summary_mu$mean,
  lower = summary_mu$q5,
  upper = summary_mu$q95
)

df_eta <- tibble(
  type = "Item Intercept",
  index = seq_along(true_eta),
  true = true_eta,
  estimate = summary_eta$mean,
  lower = summary_eta$q5,
  upper = summary_eta$q95
)

df_f <- tibble(
  type = "Time Effect",
  index = seq_along(true_f),
  true = true_f,
  estimate = summary_f$mean,
  lower = summary_f$q5,
  upper = summary_f$q95
)

# Combine and plot
df_all <- bind_rows(df_mu, df_eta, df_f)

ggplot(df_all, aes(x = true, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.05, alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray") +
  facet_wrap(~type, scales = "free") +
  labs(title = "True vs Estimated Parameters", x = "True Value", y = "Posterior Mean ± 90% CI") +
  theme_minimal()
```


